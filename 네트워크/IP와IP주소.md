# IP(Internet Protocol)
IP는 네트워크 계층에서 사용되는 대표적인 프로토콜이다. IP는 IPv4와 IPv6로 두 버전이 존재한다. 

IP의 역할은 대표적으로 **IP 주소 지정**과 **IP 단편화**가 있다. 

IP 주소 지정은 **IP 주소를 바탕으로 송수신지를 지정**하는 것이며, IP Fragmentation(단편화)는 데이터의 크기가 MTU라는 최대 전송 단위보다 클 경우 이를 **패킷을 작은 단위로 쪼개는 것**을 의미한다.

> [!NOTE]
> MTU란,
> MTU(Maximum Transmission)는 네트워크 계층에서 한 번에 전송 가능한 메시지의 최대 크기
> 
> 전송하려는 메시지의 크기가 MTU를 넘어갈 경우 단편화가 발생.
> 
> MTU의 크기는 이더넷(v2)의 경우 기본적으로 1500바이트를 기준으로 한다. 하지만 한번에 큰 사이즈를 데이터를 전송하기 위해 9000바이트로 확장된 MTU를 사용하기도 한다. 이를 점포 프레임이라 부른다.
> 
> 하지만, 9000바이트의 MTU를 효과적으로 사용하기 위해선 메시지가 전달되면서 거치는 모든 네트워크 장치가 9000바이트의 MTU를 지원해야한다. 때문에 아직 1500바이트가 대중적으로 사용된다.
>
> 또한, CPU의 발전과 Path MTU discovery 기술이 나타나면서 점포 프레임 효율이 떨어진다.

# IP 패킷

네트워크 계층에서 사용되는 데이터 단위를 패킷, IP 패킷 혹은 IP 데이터그램이라고 부른다. IP 패킷은 상위 계층에서 전달받은 데이터(페이로드)에 헤더를 추가한 형태이다. IP 패킷의 경우 IPv4와 IPv6에 따라 헤더 구조의 차이가 있다.

## IPv4 헤더

```swift
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```

IPv4 헤더는 위와 같은 구조를 가진다. 하나씩 살펴보면

- Version (4비트)
    - IP의 버전 정보가 담긴 필드
- IHL (4비트)
    - 데이터의 시작 부분을 나타내는 필드
    - IP 헤더의 경우 4바이트 단위로 이뤄져있는데 몇개의 단위로 이뤄져있는지 해당 필드에 기록된다. 최소값은 5(Options과, Padding의 경우 필수 필드가 아니기 때문)
- Type of Service (8비트)
    - 패킷 전송의 우선순위와 서비스 품질(QoS, Quality of Service)을 결정하는 데 사용
    - 앞 3비트는 우선순위, 이후 3비트는 각각 지연, 처리량, 신뢰성을 나타냄
    - 마지막 2비트는 예약되어 사용되지 않음
- Total Length (16비트)
    - 페이로드를 포함한 패킷의 총 길이
- *Identification (16비트)
    - 패킷에 할당된 번호
    - 쪼개진 패킷을 하나의 메시지로 합치기 위해 사용되는 식별값
- *Flags (3비트)
    - 첫 비트는 예약되어 사용되지 않음
    - 두 번째 비트(DP)의 경우 단편화를 할지 말지를 결정(0 = 단편화 O, 1 = 단편화 X)
    - 세 번째 비트(MF)의 경우 마지막 패킷임을 나타나는 값(0 = 마지막 패킷, 1 = 전달되어야할 패킷이 아직 남아 있다는 뜻)
- *Fragment Offset (13비트)
    - 패킷의 순서를 나타내는 값
    - 쪼개진 패킷이 재조합 할때 오프셋 값을 통해 순서대로 합쳐짐
- *Time to Live (8비트)
    - 패킷이 네트워크상에 남아있을 수 있는 최대 (초 단위)시간값
    - 만약, 라우터가 패킷을 처리하는 시간이 1초 이내여도 1초로 적용되어 감소됨
    - 값이 0이되면 해당 패킷은 폐기되고 송신지에게 `시간 초과` 메시지 전달
- *Protocol (8비트)
    - 상위 계층의 프로토콜에 대한 정보를 나타내는 값
    - TCP의 경우 6, UDP의 경우 17
- Header Checksum (16비트)
    - 패킷의 헤더 데이터를 기반으로 계산된 값
    - 패킷이 전달되면서 헤더 손상 감지를 위해 사용됨
- *Source & Destination Address (각 32비트)
    - 송수신지의 IP 주소값
- Options (가변적)
    - 옵션 필드는 경유한 라우터 혹은 통과 시간 기록(주로 디버깅 목적)하거나 경로를 지정할 목적으로 주로 사용됨
    - 하지만 현대 네트워크에서는 사용 빈도가 매우 낮음
- Padding (가변적)
    - Options 필드 사용 시 32비트 단위를 맞추기 위해 남은 공간을 패딩으로 채움
 
## IPv6 헤더

```swift
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |           Flow Label                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                         Source Address                        +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                      Destination Address                      +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- Version (4비트)
    - IP의 버전 정보가 담긴 필드
- Traffic Class (8비트)
    - IPv4의 ToS(Type of Service)와 유사한 역할
    - 기본값은 00000000이다.
- Flow Label (20비트)
    - 특정 데이터 패킷의 흐름을 식별하고 네트워크에서 품질 보장을 제공하기 위해 사용
    - 실시간 애플리케이션이나 멀티미디어 스트리밍 등 특정 서비스에 최적화된 네트워크 처리를 가능하게 함
    - 처리가 필요 없을 경우 기본값은 0
- Payload Length (16비트)
    - 페이로드의 길이를 나타내는 필드
    - 16비트로 나타낼 수 있는 최대 크기는 216바이트까지 이상 넘어갈 경우 확장 헤더에 표시 및 해당 필드는 0
- *Next Header (8비트)
    - 상위 계층의 프로토콜 및 확장 헤더가 존재할 경우 확장 헤더를 가리킴
- *Hop Limit (8비트)
    - 패킷이 경우할 수 있는 라우터의 최대 수
    - 경우할 경우 1씩 감소함
    - 0이 될때까지 수신시에 도착하지 못하면 해당 패킷은 폐기됨
- *Extension Header
    - 기본 헤더와 페이로드 사이에 필요한 경우에 추가되는 헤더
    - 확장 헤더의 종류로는
        - 모든 경로의 네트워크 장비가 패킷을 검사하도록하는 Hop-by-Hop option 헤더
        - 수신지에서만 패킷을 검사하는 Destination option 헤더
        - 라우팅 관련 정보를 운반하는 라우팅 헤더
        - 단편화를 위한 Fragment 헤더
        - 암호화와 인증을 위한 ESP, AH
     
# IP Fragmentation(단편화)의 문제

단편화는 앞써 언급했듯 MTU 보다 큰 패킷을 전송해야할 때 패킷은 쪼개서 나눠 전송하는 것을 말하며, 전송 중인 패킷이 해당 장비(라우터)의 MTU 보다 크면 발생한다. 단편화는 전송 중 패킷을 쪼개야하기 때문에 큰 리소스가 발생한다. 또한 단편화는 1번만 발생하는 것이 아닌 쪼개진 패킷이 다음 장비의 MTU 보다 크면 추가적인 단편화가 발생한다. 추가로, 전송 과정에서 일부 데이터가 유실된 경우 전체 패킷을 다시 전송해야하는 문제 또한 있다.

때문에 최선의 방법은 수신지까지 전달되기까지 최적의 MTU 크기를 찾아 딱 맞는 사이즈로 미리 패킷을 나눠 전송하는 것이다. 이를 **경로 MTU**라고 하며, 경로 MTU를 찾는 기술을  **경로 MTU 발견**(Path MTU discovery)라고 한다.

현대의 대부분의 네트워크는 해당 기술을 지원한다. 

DF 플래그를 통해 단편화를 하지 않는다 명시하고, 패킷을 전달한다. 패킷이 MTU 보다 클 경우 오류 메시지를 보낸다. 그럼 호스트는 패킷의 사이즈를 줄여 다시 전송한다.

위 과정을 반복하여 최적의 패킷 사이즈를 찾는다.

# IP 주소

IP 주소는 네트워크 주소와 호스트 주소로 구성되어 있다. 네트워크 주소는 네트워크를 식별하는 값으로, 호스트 주소는 호스트를 식별하는 주소로 사용된다. 네트워크 주소와 호스트 주소를 구분하는 범위는 유동적이다.

- IPv4
    - `192.168.1.1`과 같이 10진수로 표기됨
    - 2^32개의 주소를 표현할 수 있음
    - 각 그룹은 8비트로 0~255 범위 안에서 정해짐
- IPv6
    - `2001:0230:abcd:ffff:01010:0000:ffff:1111`과 같이 16진수로 표기됨
    - 2^128개의 주소 표현이 가능함
    - 각 그룹은 16비트 0000~ffff 범위 안에서 정해짐

## 클래스

![image](https://github.com/user-attachments/assets/8fb0719c-c3b6-4a6b-a242-2f1b3b4134ef)
> 출처: https://brunch.co.kr/@swimjiy/44

- A 클래스
    - 구성: 1 옥텟의 네트워크 주소 + 3 옥텟의 호스트 주소
    - 초기 비트: `0`
    - IP 범위: `0.0.0.0` ~ `127.255.255.255`
    - 네트워크 수: 128(2^7)개
    - 최대 호스트 수: 16,777,214(2^24 - 2)개
- B 클래스
    - 구성: 2 옥텟의 네트워크 주소 + 2 옥텟의 호스트 주소
    - 초기 비트: `10`
    - IP 범위: `128.0.0.0` ~ `191.255.255.255`
    - 네트워크 수: 16,384(2^14)개
    - 최대 호스트 수: 65,532(2^16 - 2)개
- C 클래스
    - 구성: 3 옥텟의 네트워크 주소 + 1 옥텟의 호스트 주소
    - 초기 비트: `110`
    - IP 범위: `192.0.0.0` ~ `223.255.255.255`
    - 네트워크 수: 2,097,152(2^21)개
    - 최대 호스트 수: 254(2^8 - 2)개
 
## 서브넷 마스크

서브넷 마스크는 클래스 대신 네트워크 주소와 호스트 주소를 구분하는 방법이다. 서브넷 마스크는 IP 주소와 동일한 사이즈의 비트를 가지며, IP 주소와 서브넷 마스크의 비트를 **AND 연산**을 통해 네트워크 주소를 구분한다.

- IP 주소
    - `01111111.10101111.10101010.01100110`(`127.175.170.102`)
- 서브넷 마스크
    - `11111111.11111111.11111111.11000000`(`255.255.255.192`)
- AND 연산(네트워크 주소)
    - `11111111.11111111.11111111.11000000`(`127.175.170.64`)

위와 같이 IP 주소와 서브넷 마스크를 AND 연산해서 도출된 `127.175.170.64`가 네트워크 주소가 된다. 즉, 서브넷 마스크의 1이 자리 수 만큼 네트워크 주소가 된다.

이처럼 서브넷 마스크를 이용하면 좀 더 세분화해 네트워크의 크기를 나눌 수 있으며 이를 **서브네팅**이라한다.

IP 주소와 서브넷 마스크를 함께 표기하는 방법은, IP 주소와 서브넷 마스크의 1의 수를 함께 표기하는 방식이 주로 사용된다.

- IP주소/서브넷 마스크
    - `127.175.170.102/26`
 
# IP 주소 할당을 위한 DHCP

DHCP는 동적으로 IP 주소를 할당받는 과정에서 클라이언트와 DHCP 서버간 메시지를 주고받기 위해 사용되는 프로토콜이다.

DHCP 서버의 역할은 일반적으로 라우터가 수행하지만, 특정 호스트에게 직접 부여할 수도 있다. DHCP 서버는 클라이언트에게 할당 가능한 IP 주소 목록을 관리한다.

다음 과정을 통해 클라이언트는 DHCP 서버를 통해 IP 주소를 할당받는다.

![image (1)](https://github.com/user-attachments/assets/9fb9e07f-c771-4596-ae38-0965f4857c4b)
> 출처: https://www.howtonetwork.com/comptia-network-study-guide-free/what-is-dhcp/

1. DHCP Discover
    - 클라이언트가 DHCP 서버를 찾기 위해 브로트캐스트 메시지 전송
    - IP 주소를 할당받기 전이므로 해당 시점 클라이언트 IP 주소는 `0.0.0.0`으로 설정되어 있음
2. DHCP Offer
    - 요청을 받은 DHCP 서버가 클라이언트에게 보내는 메시지
    - 클라이언트에게 할당할 주소와 서브넷 마스크, 임대 기간 등이 포함된 메시지
3. DHCP Request
    - DHCP Offer에 대한 응답 메시지이며 브로드캐스트로 전송
    - 아직 할당되기 전
4. DHCP Acknowledgment
    - DHCP가 최종적으로 보내는 메시지
    - 해당 메시지를 받은 클라이언트는 IP 주소를 사용한다.
  
- DHCP의 데이터 구조
    
    ```swift
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
       +---------------+---------------+---------------+---------------+
       |                            xid (4)                            |
       +-------------------------------+-------------------------------+
       |           secs (2)            |           flags (2)           |
       +-------------------------------+-------------------------------+
       |                          ciaddr  (4)                          |
       +---------------------------------------------------------------+
       |                          yiaddr  (4)                          |
       +---------------------------------------------------------------+
       |                          siaddr  (4)                          |
       +---------------------------------------------------------------+
       |                          giaddr  (4)                          |
       +---------------------------------------------------------------+
       |                                                               |
       |                          chaddr  (16)                         |
       |                                                               |
       |                                                               |
       +---------------------------------------------------------------+
       |                                                               |
       |                          sname   (64)                         |
       +---------------------------------------------------------------+
       |                                                               |
       |                          file    (128)                        |
       +---------------------------------------------------------------+
       |                                                               |
       |                          options (variable)                   |
       +---------------------------------------------------------------+
    ```
    
    - **op (Operation Code)**
        - 메시지의 유형 (1 = 클라이언트 → DHCP, 2 = DHCP → 클라이언트)
    - **htype (Hardware Type)**
        - 클라이언트의 네트워크 인터페이스 유형(ex. 1 = 10Mbps 이더넷)
    - **hlen (Hardware Address Length)**
        - 클라이언트 MAC 주소 길이
    - **hops**
        - 메시지가 거처야할 경로 수
        - 일반적으로 0
    - **xid (Transaction ID)**
        - 클라이언트가 랜덤으로 생성하는 값
        - 식별 값으로 사용
    - **secs (Seconds Elapsed)**
        - 클라이언트가 주소를 요청한 후 경과한 시간(초 단위)
        - DHCP 프로세스의 경과 시간을 추적하기 위해 사용
    - **flags**
        - 통신 방식을 나타내는 플래그(ex. `0x8000` = 브로드캐스트)
        - 갱신을 위한 DHCP 메시지에는 유니캐스트에 해당하는 플레그 값이 포함됨
    - **ciaddr (Client IP Address)**
        - 클라이언트가 현재 사용 중인 IP 주소(갱신 시에만 포함되어 있음)
    - **yiaddr (Your IP Address)**
        - 서버가 클라이언트에게 제안하는 IP 주소(업데이트가 필요한 경우에만 포함되어 있음)
    - **siaddr (Server IP Address)**
        - DHCP 서버의 IP 주소
    - **giaddr (Gateway IP Address)**
        - 클라이언트와 DHCP 서버 중간에 위치한 네트워크 장비의 주소값
        - 중간에 또 다른 네트워크 장비가 존재할 경우에 포함됨
    - **chaddr (Client Hardware Address)**
        - 클라이언트의 MAC 주소
    - **sname (Server Name)**
        - DHCP 서버의 호스트 이름(선택 사항)
    - **file (Boot File Name)**
        - 부팅 시 사용할 파일의 이름
        - Boot File은 DHCP 서버가 클라이언트에게 제공하는 파일의 경로 또는 이름으로, 클라이언트가 네트워크 부팅(Network Boot)을 수행할 때 필요한 운영체제, 커널, 혹은 초기화 프로그램을 포함
    - **options (Optional Parameters)**
        - 서브넷 마스크, 임대 기간 등이 포함된 필드
     
> [!NOTE]
> 동적 할당을 IP 주소를 할당받을 시엔 임대 시간이 존재하기 때문에 클라이언트는 임대 시간이 끝나기 전 기간을 연장하기 위해 두 차례 임대 갱신 요청을 보낸다.
>
> 이때는 브로트캐스트가 아닌 서버에 직접 유니캐스트 형태로 메시지를 전달하며, 두 차례 모두 실패 시 IP 주소는 반납된다.

# 참고
- 책
  - 혼자 공부하는 네트워크
- 링크
  - https://datatracker.ietf.org/doc/html/rfc2460#autoid-13
  - https://datatracker.ietf.org/doc/html/rfc791
  - https://hippogrammer.tistory.com/211
  - https://jacking75.github.io/network_10gbe/
  - https://datatracker.ietf.org/doc/html/rfc2131
